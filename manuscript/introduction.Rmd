# Introduction

<!-- 1. Why charge? / Charge is important -->
Molecules and materials are composed of atoms, and the contributions of atoms are visible in the electron density function as roughly spherical concentrations of electron density [@baderbook].
A model of the electron density as a sum of spherical contributions provides an approximation to the electrostatic potential, with increasing accuracy at larger distances.
In this model, the electron density is fully described by a partial charge on each atom.
Consequently, partial charge assignment is an essential part of polarizable force fields, to approximate the electrostatic energy, with charges often derived from charge equilibration (QEq) [@polarizableFFReviewJing].
A similar approximation scheme is used to include electrostatic energy in semiempirical quantum mechanics in the SCC-DFTB [@scc1998] and xTB [@gfn1xtb] methods, though the charges are obtained by iteration to self-consistency.
However, QEq has been proposed as a means of avoiding this iteration in xTB [@gfn0xtb].
Machine learning (ML) interatomic potentials have also introduced electrostatic energy terms based on partial charge predictions, including methods using QEq [@Anstine2023].
Empirical methods such as these can predict properties much faster than _ab initio_ methods such as density functional theory, enabling prediction for larger molecules, longer timescales in molecular dynamics, and larger combinatorial spaces of molecules and materials.

<!-- 2. Charge equilibration / You should get it from charge equilibration -->
QEq begins by assigning each atom $k$ an electronegativity $\chi^0_k$ and a hardness $\eta_k$, which define a linear system that is solved to obtain atomic charges $q_k$ [@conceptualDFTElectronegativityOriginal].
In the original formulation of QEq, these parameters depend only upon the element of the atom, but in recent ML potentials, they are predicted from local environment.
The advantage is that while these parameters depend only on local environment, charge itself can be affected by distant parts of the molecule competing for the same fixed pool of charge [@Ko2021].

<!-- 3. Conceptual DFT / Electronegativity is a real thing -->
The theoretical foundation of charge equilibration began with defining the electronegativity $\chi$ of a system as the negative of the chemical potential of its electrons, or equivalently, the derivative of the energy with respect to the electric charge, $q$ [@parrcdftelectronegativity].
Defined this way, electronegativity is an increasing function of charge, $\chi(q)$.
For example, the fluorine atom is very electronegative (high $\chi(0)$), but the fluorine anion less so (smaller $\chi(-1)$).
A discrete difference approximation to this $\chi(0)$ yields the familiar Mulliken electronegativity.
@parrAbsoluteHardness also identified the derivative of the electronegativity with the hardness $\eta$ from the hard and soft acids and bases theory.
This work became the basis of conceptual density functional theory, in which the concepts of chemistry are interpreted in terms of density functional theory (DFT) [@geerlingsconceptualDFTreview].

Defining the electronegativity of a system is not sufficient to provide the theoretical basis of QEq.
The first QEq method began by associating an electronegativity $\chi_k$ with an atom $k$ in the system, defined as the derivative of the total energy with respect to the charge $q_k$ of that atom, holding the other charges constant [@conceptualDFTElectronegativityOriginal].
The $\chi^0_k$ parameter of charge equilibration is the electronegativity an atom would have if neutral, and the hardness parameter $\eta_k$ determines the rate at which electronegativity increases as it becomes more positive.
At the equilibrium, every atom has the same electronegativity $\chi_k(\vect{q}) = \chi$.
For example, while a neutral oxygen atom is more electronegative than a neutral carbon atom, in carbon monoxide, the negative oxygen and positive carbon have equal electronegativities.
QEq, then, consists of solving for the vector of atomic charges $\vect{q}$ such that all atomic electronegativities are equal, yielding a prediction of the charges.

<!-- 4. Parameter estimation / Parameter estimation is an interesting topic and could be done better -->
For practical use, the QEq model must be trained using a dataset of reference charges.
That is, the parameters of the model, whether the element-specific $\chi^0_k$ and $\eta_k$ values of a classical QEq model or the much larger number of parameters used by a modern ML model to assign environment-dependent $\chi^0_k$ and $\eta_k$, are determined by minimizing a loss function.
That loss function is the error of charge prediction on a training dataset consisting of DFT simulations.

<!-- 5. q-prediction and partial charge / We currently only do q-prediction, but... -->
Producing a training dataset for a charge model from DFT simulations requires a definition of partial charge.
However, there is no unique definition.
Several partial charge definitions, including the Bader, Becke and Hirshfeld methods, define partial charge in terms of the electron density, by associating with each atom a weight function [@pendas2023atoms].
To produce a training dataset for a charge model, the charges are computed by integrating the weight functions against the electron density.
Once a definition of partial charge has been chosen, it implies a precise definition of electronegativity as the derivative of energy with respect to that measure of charge.

<!-- 6. χ-prediction and the linear model / We should be doing χ-prediction instead -->
QEq is based on a modeling assumption that the atomic electronegativities $\chi_k(q)$ vary linearly with the charge $q$, with $\chi^0_k$ as the intercept and the hardness $\eta_k$ as the slope. <!-- consider adding the formulas here and referencing them in the theory section since they become relevant here. i.e. in theory you say here we can derive eqn (intro x) from blahblah -->
There is thus a tension between its physical basis as a model for $\chi$, and the training procedure which minimizes error in predicting $q$.
Perhaps it is natural since prediction of the charges $q$ are the ultimate purpose of QEq, but it is worth considering framing the problem as prediction of $\chi$ instead, at least for the purposes of training.
We will refer to prediction of the charges as "$q$-prediction".
The alternative is training the model in the $\chi$-prediction task, by minimizing the error in the predicted atomic electronegativities.

So far, training of charge equilibration models has always proceeded by minimizing error in the $q$-prediction task.
Both classical charge-equilibration models with element-specific QEq parameters [@verstraelenElectronegativityParameters] and ML methods with environment-dependent QEq parameters have been trained to minimize the same loss function, the error in $q$-prediction.

<!-- Linear regression -->
The physical assumptions underlying QEq imply a linear model for the $\chi$-prediction task.
Consider classical QEq, with $\chi^0_k$ and $\eta_k$ parameters corresponding to each element.
When framed as $\chi$-prediction, these parameters appear as weights in a linear model, with charges as predictors and electronegativity as the data to be predicted.
We will demonstrate for the first time that these parameters can be determined with standard linear regression.

<!-- Training on the χ-prediction task is feasible because you can get the data -->
Training on the $\chi$-prediction task requires a dataset with not only atomic charges $q_k$ but atomic electronegativity $\chi_k$ for each atom.
When an external potential is applied to a system, atomic electronegativities are related to the strength of the potential, and can be computed up to a constant.
Since $\chi_k$ is the negative of a chemical potential, the underlying principle is measuring an "internal" chemical potential with an "external" one from the applied field, in the terminology of @kittel1980thermal.
Another way to compute atomic electronegativities is with constrained DFT, in which desired charges are given as input.
The output includes a Lagrange multiplier for each atom that is related to the electronegativity, according to a thermodynamic relation [@KadukConstrainedDFTReview].
Either by applying external potentials directly or with constrained DFT, a training dataset can be obtained that is annotated with atomic electronegativities.

<!-- Training on the χ-prediction task is fine because we can still get q -->
Training a model to map $q$ to $\chi$ may seem to defeat the purpose, since we want $q$ as output, and do not have it available as input in real prediction tasks.
However, through electronegativity equalization, a model for the $\chi$-prediction task can also be used for $q$-prediction.
Although we will focus on the linear model underlying QEq, equalizing electronegativity could also be used with non-linear models.

<!-- Analogy to force / If force prediction is easier, probably so is χ-prediction -->
The advantages of training with $\chi$-prediction is suggested by analogy to another prediction task, prediction of equilibrium geometries.
The equilibrium geometry of a molecule or material is usually predicted by solving for the geometry at which forces are zero.
The distinction between predicting geometry directly, and indirectly by way of force, can be illustrated with the machine learning tasks in the Open Catalyst Project OCP challenge.
OCP ranks models on a task in which a machine learning model predicts a relaxed geometry from an initial geometry, as well as a separate task in which a model predicts forces [@kolluru2022openchallengesdevelopinggeneralizable].
We propose an indirect approach using atomic electronegativity.
Consider that the force is the negative derivative of energy with respect to nuclear position, just as electronegativity is the derivative of energy with respect to charge.
Electronegativity equalization, then, is analogous to prediction of a geometry by solving for zero charges.

In this work, we will demonstrate how to construct a training dataset for the $\chi$-prediction task by applying potentials to individual atoms.
To demonstrate fitting a model to the $\chi$-prediction task, we will fit the simplest possible predictive model, the linear model, yielding an EEq parametrization through linear regression.
